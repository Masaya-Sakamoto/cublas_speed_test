# データ集計プログラム依頼

## 依頼概要
以下依頼概要を箇条書きで説明する:
- pythonでプログラムを作成してください。
- このプロジェクトディレクトリのルートディレクトリ直下にpythonというディレクトリがあるので全ての実行プログラム他は全てこの下につくること
- 集計にはsqliteを使用すること

## 事前知識
まず、docs/*.mdの内容を参照してください。

## 試行プログラム概要
計測に用いるプログラムはそれぞれcblas_col_speed_test.cpp, cblas_row_speed_test.cpp, cublas_speed_test.cuです。それぞれのプログラムをビルドすると、その実行時に行列の大きさを表す3つの整数M, N, Kと、実行回数nを引数として認識するプログラムが作成されます。
```bash
cd lib
./build.sh    # プログラムがビルドされる
```
するとlib/build内に次のプログラムが生成される:
- cblas_col_speed_test
- cblas_row_speed_test
- cublas_speed_test

プログラムの実行方法
```
<*blas_speed> M N K n
```

このプログラムを実行すると行列の計算にかかった時間のn回算術平均、標本標準偏差、（主にGPUに対して）デバイスにメモリコピーするためにかかった時間n回算術平均、その標本平均、デバイスからホストにメモリコピーするためにかかった時間n回算術平均、その標本平均がカンマ分けで標準出力されます。
```
<*blas_speed> M N K n
<実行時間平均>,<実行時間誤差>,<デバイスコピー時間平均>,<デバイスコピー時間誤差>,<ホストコピー時間平均>,<ホストコピー時間誤差>
```

## M, N, K選択方法
集計プログラムを実行するときにM_min, M_max, N_min, N_max, K_min, K_maxを引数として渡すようにしてください。
全ての組み合わせを調査するととても長い時間がかかるため、実験計画法で推定する。ただし、M*K, K*N, M*Nはすべて32の倍数になるようにする。

## 開発にあたっての注意事項
- 実行前にこの依頼書を元にしたdesign docをdocsディレクトリ直下に作成すること
- design docを元に計画書をdocsディレクトリ直下に作成すること
- 疑問点がある場合は質問すること
- こまめにgitリポジトリにコミットすること



> gpt-4o
Pythonでデータ収集プログラムを作成するために、以下の手順に従います。  

### **設計ドキュメント**  
- `docs/` ディレクトリ内に設計ドキュメントを作成し、データ収集プログラムの構造と機能を概説します。  
- このドキュメントには、以下の内容を含めます。  
  - 既存の測定プログラム（`cblas_col_speed_test`、`cblas_row_speed_test`、`cublas_speed_test`）との連携方法  
  - SQLiteを使用したデータの収集および保存方法  
  - 行列サイズや繰り返し回数の入力パラメータの処理方法  

### **プログラム構成**  
- Pythonプログラムは `python/` ディレクトリ内に作成します。  
- 以下の機能を含めます。  
  - 指定されたパラメータで測定プログラムを実行  
  - 測定プログラムの出力を解析  
  - 結果をSQLiteデータベースに保存  
  - 行列サイズや繰り返し回数の入力パラメータを処理（`M*K`、`K*N`、`M*N` が32の倍数であることを保証）  

### **実装計画**  
Pythonプログラムを以下の段階で実装します。  

1. **実行モジュール**: 測定プログラムを実行し、その出力を取得するモジュールを作成  
2. **解析モジュール**: 出力を解析し、必要なデータを抽出するモジュールを作成  
3. **データベースモジュール**: 抽出したデータをSQLiteデータベースに保存するモジュールを作成  
4. **メインプログラム**: 各モジュールを統合し、ユーザー入力を処理しながらデータ収集を管理するプログラムを作成  

### **頻繁なコミット**  
進捗をGitリポジトリに頻繁にコミットし、バージョン管理と追跡を確実に行います。  

### **質問**  
- SQLiteデータベースのフォーマットや構造に関して、特定の要件はありますか？  
- データの可視化やレポート作成など、追加機能を含めるべきでしょうか？  

設計ドキュメントを作成・レビューした後、実装に進みます。  
計画を確認し、変更点や追加要件があればお知らせください。

> わたし
はい。問題ありませんので進めてください。ただし、以下の内容に注意してください。
- 実行計画は特に実行テストと検証を通じて品質を向上させるように努めてください。
- M, N, Kを設定するにあたり、それまでの結果から実験計画法で、より有意な検証ができるように注意してください。

<!--
> わたし
現在の`main_program.py`のプログラムは以下のようになっています：
```python
    for M in range(M_min, M_max + 1, 32):
        for N in range(N_min, N_max + 1, 32):
            for K in range(K_min, K_max + 1, 32):
                try:
                    validate_parameters(M, N, K)
                    output = execute_program(program_path, M, N, K, iterations)
                    results = parse_output(output)
                    store_results(db_path, M, N, K, iterations, results)
                except ValueError as e:
                    print(f"Skipping invalid parameters M={M}, N={N}, K={K}: {e}")
                except Exception as e:
                    print(f"Error processing M={M}, N={N}, K={K}: {e}")
```
これを、既存の集計結果からガウス過程で平均の計算時間の推定値を計算し、推定された平均の計算時間の分散が最大になるM_float, N_float, K_floatが計算できます。M_float, N_float, K_floatの近くの整数点(M, N, K)が前述の条件：M*Kが32の倍数でかつK*Nが32の倍数でかつM*Nが32の倍数を満たす場合に、そのM, N, Kで新たに計測するように変更してください。
-->

> わたし
実施計画を管理できるようにしたいです。私が現在考えている方式を示します:
1. exec_id, M, N, K, statusのsqliteデータベースを作成する。
2. 実験をする際にはそのデータベースから、statusが未実行のrowからM, N, Kを取り出して、実験を行う。
3. 実験の終了とともにstatusを変更するようにしたいです。

先ず、その様なプログラムに改良するための計画を立てましょう。

<!--
TODO:
- スケジュールデータベースに優先クラスカラムを作る
    - jobのnice値のようなものを想定している
    - 優先クラスがついているものとそうでないものに分けて考える
    - 優先クラスがついているものの中で探索し、その結果を元に新たに優先クラスがついているスケジュールを選択する
    - 優先クラスがついているスケジュールがない場合、ランダムで実行する
- スケジュールデータベースに条件を満たすM, N, Kを全て入れる
- 実行計画更新グリッドを設定する関数をつくる
- 実行プログラムごとに実行スケジュールを個別に設定する
- プログラムの変更とデータベースの変更を容易に行うことができるようにする
- 実行プログラムのリストを外部のファイル(JSONなど）から読み出すようにする

[プログラム別の実行計画]
1. パラメタデータベースを作成する
2. パラメタデータベースの初期化関数を作成する
3. スケジュールのパラメタ設定をパラメタデータベースのIDと紐付ける
4. スケージュールに紐付いたパラメタを利用するように変更する
5. スケジュールにnice値を設定できるようにする
6. パラメタの最小値と最大値をファイルから読み出すようにする
7. データベースのテンプレートを作成する
8. 実行プログラムをbuildディレクトリから参照してJSONファイルを作成する
9. JSONファイルから対応する実行計画データベースを作成する
10. 実行プログラムと実行計画データベースの関連付けを行う
-->

> わたし
スケジュールデータベースにパラメタを直接記述することを取りやめて、新たに作成するパラメタデータベースと紐付けることにします。
そのために必要なプランを作成して、そのプランをdocs/ディレクトリ以下にmarkdown形式で保存してください。
- パラメタデータベースのカラムはid, M, N, Kであるとします。
- スケージュールデータベースが今までM, N, Kを持っていましたが、この変更のためパラメタデータベースのIDを持つことで代替します。
- 実験結果を収めたデータベースも同様にM, N, Kをパラメタデータベースの当該IDで置き換えます。

## パラメタデータベース初期化関数の作成依頼
> わたし
パラメタデータベースを初期化する関数を作ってください。このときM, N, Kのリストを受け取り、それぞれの要素に対してidを割り当ててデータベースに挿入するようにしてください。つまり作業内容は以下の通りです：
1. 新規作成する関数はm_list, n_list, k_listを受け取る。
2. for M, for N, for Kの３重ループでそれぞれの要素に対してidを割り当ててデータベースに挿入する。
以上の作業が完了したら、この作業の目的と変更についてmarkdown形式のドキュメントをdocs/ディレクトリ直下に作成してください。

> わたし
このプログラムでは先ずパラメタデータベースがあって、そこからスケジュールを作成、そして実験、結果を結果のデータベースに保存という流れなので、スケジュールに未登録のパラメタがパラメタデータベースに存在しない場合はスケジュールを全て実行した後にメインプログラムが正常終了するようにしてください。したがって、メインプログラムに現在記述されたスケジュールが存在しない場合のループは不要です。

> わたし
不具合修正依頼です。mainプログラムで`schedule_exists`がない場合次のようになっています。
```python
    if not schedule_exists:
        for parameter_id in range(1, len(range(M_min, M_max + 1, 32)) * len(range(N_min, N_max + 1, 32)) * len(range(K_min, K_max + 1, 32)) + 1):
            insert_schedule(db_path, parameter_id)
```
parameter_idを`range`関数から取得していますが、これをパラメタデータベースから取得するようにしてください。つまり、以下のようにすると良いと思います：
1. パラメタデータベースの`id`集合の内で、スケジュールデータベースの`parameter_id`集合に存在しないものを取り出す。これがスケジュールデータベースに未登録なparameter_idになります。　
2. 取り出した未登録なparameter_idをスケジュールデータベースに登録し、同時にその行の`status`を
3. 再度スケジュールデータベースを確認して、新たに`schedule_exists`を取り出す。

また、パラメタデータベースはこのメインプログラムを実行する以前に初期化されていなければなりません。したがって、パラメタデータベースの初期化は`main_program.py`とは別のプログラムファイルにしてしまうことが良いと考えます。

上記内容サマリーと、今の所私が思いついている作業範囲を書きます。
- パラメタデータベース初期化用に新たなプログラムファイルを作成する。
- `insert_parameter`関数をparameter_database_module.pyに作成して、パラメタを登録できるようにする。
- `insert_schedule`関数の実装をparameter_idを用いるように修正する。
- mainプログラムを修正する。

> わたし
加えて、パラメタデータベースの`id`リストと、スケジュールデータベースの`parameter_id`リストを比較して差分を抽出するクエリを書いて、差分をリストにする関数を追加する必要があると考えました。

> わたし
差分を取り出す関数はどのファイルに記述することが良いと考えますか？